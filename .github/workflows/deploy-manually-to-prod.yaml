name: Manual deploy of main to prod

on:
  workflow_call:

run-name: Prod deploy of ${{ github.ref_name }}

jobs:
  deploy_manually_to_prod:
    name: Deploy
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: navikt/klage-workflows/.github/actions/deploy-nais-app-with-custom-checkout@main
        with:
          build-tag: ${{ github.sha }}
          nav-cluster: prod-gcp
          nav-environment: prod

      - name: Login to image registry
        id: image-registry
        uses: nais/login@v0
        with:
          team: klage

      - name: Install crane
        uses: imjasonh/setup-crane@v0.5

      - name: Get version tag from image
        id: version
        run: |
          IMAGE=${{ steps.image-registry.outputs.registry }}/${{ github.event.repository.name }}
          
          echo "Getting digest for SHA tag..."
          START=$(date +%s%3N)
          DIGEST=$(crane digest ${IMAGE}:${{ github.sha }})
          echo "Digest: ${DIGEST} (took $(($(date +%s%3N) - START))ms)"
          
          echo "Listing tags..."
          START=$(date +%s%3N)
          TAGS=$(crane ls ${IMAGE} | grep -E '^[0-9]{4}\.[0-9]{2}\.[0-9]{2}' | sort -r)
          echo "Found $(echo "${TAGS}" | wc -l) date-formatted tags (took $(($(date +%s%3N) - START))ms)"
          
          echo "Finding matching tag..."
          START=$(date +%s%3N)
          COUNT=0
          for TAG in ${TAGS}; do
            COUNT=$((COUNT + 1))
            if [ "$(crane digest ${IMAGE}:${TAG})" = "${DIGEST}" ]; then
              echo "Found match: ${TAG} after checking ${COUNT} tags (took $(($(date +%s%3N) - START))ms)"
              echo "version=${TAG}" >> $GITHUB_OUTPUT
              break
            fi
          done

      - uses: ncipollo/release-action@main
        with:
          tag: ${{ steps.version.outputs.version }}